# RBAC template tests for mcp-kubernetes Helm chart
#
# These tests verify the RBAC resources created by the Helm chart:
# - RBAC profiles (minimal, readonly, standard, admin)
# - Custom RBAC rules
# - CAPI mode ClusterRole for cluster discovery and auth
# - Namespace-scoped Roles for kubeconfig secret access (recommended)
# - Cluster-wide secret access ClusterRole (not recommended, requires explicit opt-in)
#
# Run with: helm unittest ./helm/mcp-kubernetes

suite: RBAC template tests
templates:
  - templates/rbac.yaml
tests:
  # ==========================================
  # Basic RBAC Tests
  # ==========================================
  
  - it: should create basic ClusterRole and ClusterRoleBinding
    set:
      serviceAccount.create: true
      rbac.create: true
      capiMode.enabled: false
    asserts:
      - hasDocuments:
          count: 2
      - isKind:
          of: ClusterRole
        documentIndex: 0
      - isKind:
          of: ClusterRoleBinding
        documentIndex: 1

  - it: should not create any RBAC when serviceAccount.create is false
    set:
      serviceAccount.create: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should not create any RBAC when rbac.create is false
    set:
      serviceAccount.create: true
      rbac.create: false
      capiMode.enabled: false
    asserts:
      - hasDocuments:
          count: 0

  # ==========================================
  # RBAC Profile Tests
  # ==========================================

  - it: should create minimal profile with empty rules
    set:
      serviceAccount.create: true
      rbac.create: true
      rbac.profile: "minimal"
      capiMode.enabled: false
    asserts:
      - hasDocuments:
          count: 2
      - equal:
          path: metadata.annotations["mcp-kubernetes.giantswarm.io/rbac-profile"]
          value: "minimal"
        documentIndex: 0
      # Minimal profile should have empty rules
      - isNull:
          path: rules
        documentIndex: 0

  - it: should create readonly profile with get/list/watch verbs only
    set:
      serviceAccount.create: true
      rbac.create: true
      rbac.profile: "readonly"
      capiMode.enabled: false
    asserts:
      - hasDocuments:
          count: 2
      - equal:
          path: metadata.annotations["mcp-kubernetes.giantswarm.io/rbac-profile"]
          value: "readonly"
        documentIndex: 0
      # Readonly should have rules with only read verbs
      - contains:
          path: rules
          content:
            apiGroups: [""]
            resources: ["pods", "services", "endpoints", "nodes", "namespaces", "configmaps", "persistentvolumes", "persistentvolumeclaims", "events"]
            verbs: ["get", "list", "watch"]
        documentIndex: 0

  - it: should create standard profile with CRUD permissions
    set:
      serviceAccount.create: true
      rbac.create: true
      rbac.profile: "standard"
      capiMode.enabled: false
    asserts:
      - hasDocuments:
          count: 2
      - equal:
          path: metadata.annotations["mcp-kubernetes.giantswarm.io/rbac-profile"]
          value: "standard"
        documentIndex: 0
      # Standard should have CRUD operations
      - contains:
          path: rules
          content:
            apiGroups: [""]
            resources: ["pods", "services", "endpoints", "nodes", "namespaces", "configmaps", "secrets", "persistentvolumes", "persistentvolumeclaims", "events"]
            verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
        documentIndex: 0

  - it: should fail when admin profile is used without confirmation
    set:
      serviceAccount.create: true
      rbac.create: true
      rbac.profile: "admin"
      rbac.adminConfirmation: false
      capiMode.enabled: false
    asserts:
      - failedTemplate:
          errorMessage: "SECURITY: The 'admin' RBAC profile grants dangerous permissions including RBAC management (privilege escalation), pod exec (container escape), and webhook configuration (API interception). To use this profile, you must explicitly set 'rbac.adminConfirmation: true' to confirm you understand these risks."

  - it: should create admin profile with full access and security warning when confirmed
    set:
      serviceAccount.create: true
      rbac.create: true
      rbac.profile: "admin"
      rbac.adminConfirmation: true
      capiMode.enabled: false
    asserts:
      - hasDocuments:
          count: 2
      - equal:
          path: metadata.annotations["mcp-kubernetes.giantswarm.io/rbac-profile"]
          value: "admin"
        documentIndex: 0
      # Admin should have security warning annotation
      - isNotEmpty:
          path: metadata.annotations["security.kubernetes.io/warning"]
        documentIndex: 0
      # Admin should have RBAC management permissions
      - contains:
          path: rules
          content:
            apiGroups: ["rbac.authorization.k8s.io"]
            resources: ["roles", "rolebindings", "clusterroles", "clusterrolebindings"]
            verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
        documentIndex: 0

  - it: should not include deprecated podsecuritypolicies in admin profile
    set:
      serviceAccount.create: true
      rbac.create: true
      rbac.profile: "admin"
      rbac.adminConfirmation: true
      capiMode.enabled: false
    asserts:
      # Policy rules should only include poddisruptionbudgets, not podsecuritypolicies
      - contains:
          path: rules
          content:
            apiGroups: ["policy"]
            resources: ["poddisruptionbudgets"]
            verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
        documentIndex: 0

  - it: should default to standard profile when not specified
    set:
      serviceAccount.create: true
      rbac.create: true
      capiMode.enabled: false
    asserts:
      - equal:
          path: metadata.annotations["mcp-kubernetes.giantswarm.io/rbac-profile"]
          value: "standard"
        documentIndex: 0

  # ==========================================
  # Custom RBAC Rules Tests
  # ==========================================

  - it: should use custom rules when custom.enabled is true
    set:
      serviceAccount.create: true
      rbac.create: true
      rbac.profile: "readonly"
      rbac.custom.enabled: true
      rbac.custom.rules:
        - apiGroups: [""]
          resources: ["pods"]
          verbs: ["get", "list"]
    asserts:
      - hasDocuments:
          count: 2
      # Custom rules should be present
      - contains:
          path: rules
          content:
            apiGroups: [""]
            resources: ["pods"]
            verbs: ["get", "list"]
        documentIndex: 0

  # ==========================================
  # OAuth Downstream Mode Tests
  # ==========================================

  - it: should add oauth-downstream annotation when enabled
    set:
      serviceAccount.create: true
      rbac.create: true
      rbac.profile: "minimal"
      mcpKubernetes.oauth.enableDownstreamOAuth: true
      capiMode.enabled: false
    asserts:
      - equal:
          path: metadata.annotations["mcp-kubernetes.giantswarm.io/rbac-mode"]
          value: "oauth-downstream"
        documentIndex: 0

  - it: should enforce minimal profile when downstream OAuth is enabled
    set:
      serviceAccount.create: true
      rbac.create: true
      rbac.profile: "standard"
      mcpKubernetes.oauth.enableDownstreamOAuth: true
      capiMode.enabled: false
    asserts:
      # Profile should be enforced to minimal
      - equal:
          path: metadata.annotations["mcp-kubernetes.giantswarm.io/rbac-profile"]
          value: "minimal"
        documentIndex: 0
      - equal:
          path: metadata.annotations["mcp-kubernetes.giantswarm.io/enforced-profile"]
          value: "minimal"
        documentIndex: 0
      # Should indicate the requested profile was overridden
      - equal:
          path: metadata.annotations["mcp-kubernetes.giantswarm.io/requested-profile"]
          value: "standard"
        documentIndex: 0
      # Rules should be empty (minimal profile)
      - isNull:
          path: rules
        documentIndex: 0

  - it: should not show override note when minimal profile explicitly requested with downstream OAuth
    set:
      serviceAccount.create: true
      rbac.create: true
      rbac.profile: "minimal"
      mcpKubernetes.oauth.enableDownstreamOAuth: true
      capiMode.enabled: false
    asserts:
      - equal:
          path: metadata.annotations["mcp-kubernetes.giantswarm.io/rbac-profile"]
          value: "minimal"
        documentIndex: 0
      - isNull:
          path: metadata.annotations["mcp-kubernetes.giantswarm.io/requested-profile"]
        documentIndex: 0

  - it: should fail when custom RBAC is enabled with downstream OAuth
    set:
      serviceAccount.create: true
      rbac.create: true
      rbac.custom.enabled: true
      rbac.custom.rules:
        - apiGroups: [""]
          resources: ["pods"]
          verbs: ["get", "list", "delete"]
      mcpKubernetes.oauth.enableDownstreamOAuth: true
      capiMode.enabled: false
    asserts:
      # Should fail with configuration error
      - failedTemplate:
          errorPattern: "CONFIGURATION ERROR: rbac.custom.enabled cannot be used with enableDownstreamOAuth"

  # ==========================================
  # CAPI Mode RBAC Tests
  # ==========================================

  - it: should create CAPI ClusterRole when capiMode is enabled
    set:
      serviceAccount.create: true
      rbac.create: true
      capiMode.enabled: true
      capiMode.rbac.allowedNamespaces: []
      capiMode.rbac.clusterWideSecrets: false
    asserts:
      - hasDocuments:
          count: 4
      - isKind:
          of: ClusterRole
        documentIndex: 0
      - isKind:
          of: ClusterRoleBinding
        documentIndex: 1
      - isKind:
          of: ClusterRole
        documentIndex: 2
      - matchRegex:
          path: metadata.name
          pattern: -capi$
        documentIndex: 2
      - isKind:
          of: ClusterRoleBinding
        documentIndex: 3

  - it: should create namespace-scoped Roles for allowed namespaces
    set:
      serviceAccount.create: true
      rbac.create: true
      capiMode.enabled: true
      capiMode.rbac.allowedNamespaces:
        - org-acme
        - org-beta
      capiMode.rbac.clusterWideSecrets: false
    asserts:
      - hasDocuments:
          count: 8
      - isKind:
          of: Role
        documentIndex: 4
      - equal:
          path: metadata.namespace
          value: org-acme
        documentIndex: 4
      - isKind:
          of: RoleBinding
        documentIndex: 5
      - equal:
          path: metadata.namespace
          value: org-acme
        documentIndex: 5
      - isKind:
          of: Role
        documentIndex: 6
      - equal:
          path: metadata.namespace
          value: org-beta
        documentIndex: 6
      - isKind:
          of: RoleBinding
        documentIndex: 7
      - equal:
          path: metadata.namespace
          value: org-beta
        documentIndex: 7

  - it: should create cluster-wide secret ClusterRole when clusterWideSecrets is enabled
    set:
      serviceAccount.create: true
      rbac.create: true
      capiMode.enabled: true
      capiMode.rbac.allowedNamespaces: []
      capiMode.rbac.clusterWideSecrets: true
    asserts:
      - hasDocuments:
          count: 6
      - isKind:
          of: ClusterRole
        documentIndex: 4
      - matchRegex:
          path: metadata.name
          pattern: -secrets$
        documentIndex: 4
      - contains:
          path: rules
          content:
            apiGroups: [""]
            resources: ["secrets"]
            verbs: ["get"]
        documentIndex: 4
      - isKind:
          of: ClusterRoleBinding
        documentIndex: 5
      - matchRegex:
          path: metadata.name
          pattern: -secrets$
        documentIndex: 5

  - it: should have security warning annotation on cluster-wide secrets ClusterRole
    set:
      serviceAccount.create: true
      rbac.create: true
      capiMode.enabled: true
      capiMode.rbac.clusterWideSecrets: true
    asserts:
      - isNotEmpty:
          path: metadata.annotations["security.kubernetes.io/warning"]
        documentIndex: 4

  - it: should always create CAPI RBAC when capiMode is enabled (rbac.create is deprecated)
    set:
      serviceAccount.create: true
      rbac.create: true
      capiMode.enabled: true
      capiMode.rbac.create: false  # This setting is now deprecated and ignored
    asserts:
      # CAPI RBAC is always created when capiMode.enabled is true
      - hasDocuments:
          count: 4
      - isKind:
          of: ClusterRole
        documentIndex: 2
      - matchRegex:
          path: metadata.name
          pattern: -capi$
        documentIndex: 2

  - it: should grant CAPI resource discovery permissions
    set:
      serviceAccount.create: true
      rbac.create: true
      capiMode.enabled: true
    asserts:
      - contains:
          path: rules
          content:
            apiGroups: ["cluster.x-k8s.io"]
            resources:
              - clusters
              - clusters/status
              - machinepools
              - machinepools/status
              - machinedeployments
              - machinedeployments/status
              - machines
              - machines/status
            verbs: ["get", "list", "watch"]
        documentIndex: 2

  - it: should grant TokenReview and SubjectAccessReview permissions
    set:
      serviceAccount.create: true
      rbac.create: true
      capiMode.enabled: true
    asserts:
      - contains:
          path: rules
          content:
            apiGroups: ["authentication.k8s.io"]
            resources: ["tokenreviews"]
            verbs: ["create"]
        documentIndex: 2
      - contains:
          path: rules
          content:
            apiGroups: ["authorization.k8s.io"]
            resources: ["subjectaccessreviews", "selfsubjectaccessreviews"]
            verbs: ["create"]
        documentIndex: 2

  - it: should reference correct ServiceAccount in RoleBinding subjects
    set:
      serviceAccount.create: true
      rbac.create: true
      capiMode.enabled: true
      capiMode.rbac.allowedNamespaces:
        - org-test
    release:
      name: test-release
      namespace: mcp-system
    asserts:
      - equal:
          path: subjects[0].kind
          value: ServiceAccount
        documentIndex: 5
      - equal:
          path: subjects[0].namespace
          value: mcp-system
        documentIndex: 5

  # ==========================================
  # RBAC Profile with CAPI Mode Tests
  # ==========================================

  - it: should combine minimal profile with CAPI RBAC
    set:
      serviceAccount.create: true
      rbac.create: true
      rbac.profile: "minimal"
      capiMode.enabled: true
      capiMode.rbac.allowedNamespaces: []
    asserts:
      - hasDocuments:
          count: 4
      # Base ClusterRole should have minimal (empty) rules
      - isNull:
          path: rules
        documentIndex: 0
      # CAPI ClusterRole should still have CAPI permissions
      - contains:
          path: rules
          content:
            apiGroups: ["cluster.x-k8s.io"]
            resources:
              - clusters
              - clusters/status
              - machinepools
              - machinepools/status
              - machinedeployments
              - machinedeployments/status
              - machines
              - machines/status
            verbs: ["get", "list", "watch"]
        documentIndex: 2

  - it: should combine readonly profile with CAPI RBAC
    set:
      serviceAccount.create: true
      rbac.create: true
      rbac.profile: "readonly"
      capiMode.enabled: true
      capiMode.rbac.allowedNamespaces: []
    asserts:
      - hasDocuments:
          count: 4
      # Base ClusterRole should have readonly rules
      - equal:
          path: metadata.annotations["mcp-kubernetes.giantswarm.io/rbac-profile"]
          value: "readonly"
        documentIndex: 0
      - contains:
          path: rules
          content:
            apiGroups: [""]
            resources: ["pods", "services", "endpoints", "nodes", "namespaces", "configmaps", "persistentvolumes", "persistentvolumeclaims", "events"]
            verbs: ["get", "list", "watch"]
        documentIndex: 0
      # CAPI ClusterRole should still have CAPI permissions
      - contains:
          path: rules
          content:
            apiGroups: ["cluster.x-k8s.io"]
            resources:
              - clusters
              - clusters/status
              - machinepools
              - machinepools/status
              - machinedeployments
              - machinedeployments/status
              - machines
              - machines/status
            verbs: ["get", "list", "watch"]
        documentIndex: 2

  - it: should combine standard profile with CAPI RBAC
    set:
      serviceAccount.create: true
      rbac.create: true
      rbac.profile: "standard"
      capiMode.enabled: true
      capiMode.rbac.allowedNamespaces: []
    asserts:
      - hasDocuments:
          count: 4
      # Base ClusterRole should have standard rules (CRUD)
      - equal:
          path: metadata.annotations["mcp-kubernetes.giantswarm.io/rbac-profile"]
          value: "standard"
        documentIndex: 0
      - contains:
          path: rules
          content:
            apiGroups: [""]
            resources: ["pods", "services", "endpoints", "nodes", "namespaces", "configmaps", "secrets", "persistentvolumes", "persistentvolumeclaims", "events"]
            verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
        documentIndex: 0
      # CAPI ClusterRole should still have CAPI permissions
      - contains:
          path: rules
          content:
            apiGroups: ["cluster.x-k8s.io"]
            resources:
              - clusters
              - clusters/status
              - machinepools
              - machinepools/status
              - machinedeployments
              - machinedeployments/status
              - machines
              - machines/status
            verbs: ["get", "list", "watch"]
        documentIndex: 2

  - it: should combine admin profile with CAPI RBAC
    set:
      serviceAccount.create: true
      rbac.create: true
      rbac.profile: "admin"
      rbac.adminConfirmation: true
      capiMode.enabled: true
      capiMode.rbac.allowedNamespaces: []
    asserts:
      - hasDocuments:
          count: 4
      # Base ClusterRole should have admin rules
      - equal:
          path: metadata.annotations["mcp-kubernetes.giantswarm.io/rbac-profile"]
          value: "admin"
        documentIndex: 0
      # Admin should have security warning
      - isNotEmpty:
          path: metadata.annotations["security.kubernetes.io/warning"]
        documentIndex: 0
      # CAPI ClusterRole should still have CAPI permissions
      - contains:
          path: rules
          content:
            apiGroups: ["cluster.x-k8s.io"]
            resources:
              - clusters
              - clusters/status
              - machinepools
              - machinepools/status
              - machinedeployments
              - machinedeployments/status
              - machines
              - machines/status
            verbs: ["get", "list", "watch"]
        documentIndex: 2

  # ==========================================
  # OAuth Downstream + CAPI Mode Tests
  # ==========================================

  - it: should enforce minimal base RBAC but still create CAPI RBAC with downstream OAuth
    set:
      serviceAccount.create: true
      rbac.create: true
      rbac.profile: "standard"  # Will be overridden to minimal
      mcpKubernetes.oauth.enableDownstreamOAuth: true
      capiMode.enabled: true
      capiMode.rbac.allowedNamespaces:
        - org-giantswarm
    asserts:
      # Should have 6 documents: base ClusterRole, base ClusterRoleBinding,
      # CAPI ClusterRole, CAPI ClusterRoleBinding, namespace Role, namespace RoleBinding
      - hasDocuments:
          count: 6
      # Base ClusterRole should be minimal (no rules)
      - equal:
          path: metadata.annotations["mcp-kubernetes.giantswarm.io/rbac-profile"]
          value: "minimal"
        documentIndex: 0
      - equal:
          path: metadata.annotations["mcp-kubernetes.giantswarm.io/enforced-profile"]
          value: "minimal"
        documentIndex: 0
      - isNull:
          path: rules
        documentIndex: 0
      # CAPI ClusterRole should still have full CAPI permissions
      - contains:
          path: rules
          content:
            apiGroups: ["cluster.x-k8s.io"]
            resources:
              - clusters
              - clusters/status
              - machinepools
              - machinepools/status
              - machinedeployments
              - machinedeployments/status
              - machines
              - machines/status
            verbs: ["get", "list", "watch"]
        documentIndex: 2
      # Namespace Role for secret access should be created
      - isKind:
          of: Role
        documentIndex: 4
      - equal:
          path: metadata.namespace
          value: org-giantswarm
        documentIndex: 4

  # ==========================================
  # SSO Passthrough Mode Tests
  # ==========================================

  - it: should create ConfigMap access instead of Secret access in SSO passthrough mode
    set:
      serviceAccount.create: true
      rbac.create: true
      capiMode.enabled: true
      capiMode.workloadClusterAuth.mode: "sso-passthrough"
      capiMode.rbac.allowedNamespaces:
        - org-giantswarm
    asserts:
      # Should have namespace Role for ConfigMap access
      - isKind:
          of: Role
        documentIndex: 4
      - equal:
          path: metadata.namespace
          value: org-giantswarm
        documentIndex: 4
      # Role should have ConfigMap access, not Secret access
      - contains:
          path: rules
          content:
            apiGroups: [""]
            resources: ["configmaps"]
            verbs: ["get"]
        documentIndex: 4
      # Check annotation indicates sso-passthrough mode
      - equal:
          path: metadata.annotations["mcp-kubernetes.giantswarm.io/wc-auth-mode"]
          value: "sso-passthrough"
        documentIndex: 4

  - it: should create Secret access in impersonation mode
    set:
      serviceAccount.create: true
      rbac.create: true
      capiMode.enabled: true
      capiMode.workloadClusterAuth.mode: "impersonation"
      capiMode.rbac.allowedNamespaces:
        - org-giantswarm
    asserts:
      # Should have namespace Role for Secret access
      - isKind:
          of: Role
        documentIndex: 4
      - contains:
          path: rules
          content:
            apiGroups: [""]
            resources: ["secrets"]
            verbs: ["get"]
        documentIndex: 4
      # Check annotation indicates impersonation mode
      - equal:
          path: metadata.annotations["mcp-kubernetes.giantswarm.io/wc-auth-mode"]
          value: "impersonation"
        documentIndex: 4
